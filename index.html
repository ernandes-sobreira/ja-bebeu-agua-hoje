<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Controle de Hidrata√ß√£o</title>

<style>
:root{
  --nav:#0b3c5d;
  --azul:#1f6fa3;
  --azul2:#2d87c8;
  --bg:#eef7fc;
  --card:#ffffff;
  --text:#0e2233;
  --muted:#5f7486;
  --line:#d7e6f1;
  --ok:#1aa774;
  --warn:#f39c12;
  --danger:#d64545;
  --shadow:0 14px 40px rgba(0,0,0,.08);
  --r:18px;
}

*{box-sizing:border-box}
body{
  margin:0;
  font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Helvetica Neue", "Noto Sans";
  background: linear-gradient(180deg, var(--bg), #ffffff 60%);
  color:var(--text);
}

header{
  background:var(--nav);
  color:#fff;
  padding:14px 16px;
  text-align:center;
  font-weight:900;
  letter-spacing:.2px;
  position:sticky;
  top:0;
  z-index:5;
}
header .sub{
  display:block;
  font-weight:500;
  opacity:.85;
  font-size:.9rem;
  margin-top:4px;
}

.container{
  max-width:1180px;
  margin:0 auto;
  padding:16px;
  display:grid;
  grid-template-columns: 360px 1fr;
  gap:16px;
}

.card{
  background:var(--card);
  border-radius:var(--r);
  box-shadow:var(--shadow);
  padding:16px;
}

h3{margin:0 0 10px;font-size:1.05rem}
hr{border:none;border-top:1px solid var(--line);margin:14px 0}

.small{font-size:.9rem;color:var(--muted)}
.muted{color:var(--muted)}

.row{display:flex;gap:10px;align-items:center}
.row > *{flex:1}

label{display:block;font-size:.85rem;color:var(--muted);margin:10px 0 6px}
input, select, textarea{
  width:100%;
  padding:10px 11px;
  border:1px solid var(--line);
  border-radius:12px;
  outline:none;
  font-size:0.95rem;
  background:#fff;
}
textarea{min-height:110px;resize:vertical}
input:focus, textarea:focus{border-color:#b9d7ea; box-shadow: 0 0 0 4px rgba(31,111,163,.12);}

.btn{
  border:none;
  border-radius:12px;
  padding:10px 12px;
  cursor:pointer;
  font-weight:900;
  transition:.15s transform ease, .15s filter ease;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap:8px;
}
.btn:active{transform:scale(.98)}
.btn.primary{background:var(--azul); color:#fff;}
.btn.soft{background:rgba(31,111,163,.12); color:var(--nav);}
.btn.ok{background:var(--ok); color:#fff;}
.btn.danger{background:var(--danger); color:#fff;}
.btn.ghost{background:transparent; border:1px solid var(--line); color:var(--nav);}

.grid3{display:grid; grid-template-columns:repeat(3,1fr); gap:8px}
.grid2{display:grid; grid-template-columns:repeat(2,1fr); gap:8px}

.badge{
  display:inline-flex;
  padding:6px 10px;
  border-radius:999px;
  font-weight:900;
  font-size:.82rem;
  background:rgba(31,111,163,.10);
  color:var(--nav);
  border:1px solid rgba(31,111,163,.18);
}

.kpis{
  display:grid;
  grid-template-columns: repeat(3,1fr);
  gap:10px;
  margin-top:10px;
}
.kpi{
  background:linear-gradient(180deg, rgba(31,111,163,.08), rgba(31,111,163,.03));
  border:1px solid rgba(31,111,163,.15);
  border-radius:14px;
  padding:10px;
  text-align:center;
}
.kpi strong{display:block;font-size:1.05rem;color:var(--nav)}
.kpi span{font-size:.82rem;color:var(--muted)}

/* Copo */
.copoWrap{display:flex; gap:14px; align-items:center}
.copo{
  width:110px;
  height:220px;
  border:4px solid var(--nav);
  border-top:8px solid var(--nav);
  border-radius:0 0 24px 24px;
  position:relative;
  overflow:hidden;
  background:#fff;
}
.agua{
  position:absolute;
  bottom:0;
  left:0;
  width:100%;
  height:0%;
  background:linear-gradient(180deg, var(--azul2), var(--azul));
  transition:height .55s ease;
}
.wave{
  position:absolute;
  left:-20%;
  width:140%;
  height:34px;
  top:-16px;
  background:rgba(255,255,255,.35);
  border-radius:50%;
  animation: wave 3.5s ease-in-out infinite;
}
@keyframes wave{
  0%{transform:translateX(0)}
  50%{transform:translateX(18px)}
  100%{transform:translateX(0)}
}

.pct{font-size:1.7rem;font-weight:1000;color:var(--nav);line-height:1.1}
.big{font-size:1.25rem;font-weight:950;color:var(--nav)}

.list{
  max-height:260px;
  overflow:auto;
  border:1px solid var(--line);
  border-radius:14px;
}
.item{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
  padding:10px 12px;
  border-bottom:1px solid var(--line);
}
.item:last-child{border-bottom:none}
.item .left{display:flex;flex-direction:column;gap:2px}
.item .right{display:flex;gap:8px; align-items:center}
.iconBtn{
  width:36px; height:36px;
  border-radius:12px;
  border:1px solid var(--line);
  background:#fff;
  cursor:pointer;
  font-size:16px;
}
.iconBtn:hover{filter:brightness(.98)}

/* Toast */
.toastWrap{
  position:fixed;
  left:50%;
  bottom:18px;
  transform:translateX(-50%);
  z-index:9999;
  display:flex;
  flex-direction:column;
  gap:10px;
  width:min(560px, calc(100vw - 24px));
  pointer-events:none;
}
.toast{
  pointer-events:auto;
  background:rgba(11,60,93,.95);
  color:#fff;
  border-radius:16px;
  padding:12px 14px;
  box-shadow: 0 18px 60px rgba(0,0,0,.18);
  display:flex;
  gap:10px;
  align-items:flex-start;
  animation: pop .22s ease;
}
@keyframes pop{
  from{transform:translateY(10px);opacity:0}
  to{transform:translateY(0);opacity:1}
}
.toast .tTitle{font-weight:1000}
.toast .tText{opacity:.92;font-size:.95rem}
.toast .x{
  margin-left:auto;
  background:rgba(255,255,255,.15);
  border:none;
  color:#fff;
  border-radius:12px;
  padding:6px 10px;
  cursor:pointer;
}

/* Confete */
.confetti{
  position:fixed;
  inset:0;
  pointer-events:none;
  z-index:9998;
  overflow:hidden;
}
.confetti i{
  position:absolute;
  top:-20px;
  width:10px; height:18px;
  opacity:.9;
  border-radius:4px;
  animation: fall 1.6s linear forwards;
}
@keyframes fall{
  to{ transform: translateY(calc(100vh + 40px)) rotate(360deg); opacity:0.95;}
}

canvas{width:100%; max-height:280px}

details{
  border:1px solid var(--line);
  border-radius:14px;
  padding:10px 12px;
  background:linear-gradient(180deg, rgba(31,111,163,.06), rgba(31,111,163,.02));
}
details summary{
  cursor:pointer;
  font-weight:900;
  color:var(--nav);
}

@media (max-width: 980px){
  .container{grid-template-columns:1fr}
}
</style>
</head>

<body>
<header>
  <span id="titleTop">üíß Controle de Hidrata√ß√£o</span>
  <span class="sub">leve, bonito e viciante ‚Äî com horas, metas, frases e import/export üòÑ</span>
</header>

<div class="container">

  <!-- ESQUERDA -->
  <div class="card">
    <h3>Perfil</h3>

    <label>Seu nome (aparece no topo e nos elogios)</label>
    <div class="row">
      <input id="nomeInput" type="text" placeholder="Ex: Ernandes"/>
      <button class="btn ok" onclick="setNome()">Salvar</button>
    </div>
    <div class="small">Fica salvo no aparelho (localStorage).</div>

    <hr>

    <div class="row" style="align-items:flex-start">
      <div>
        <h3>Copo do dia</h3>
        <div class="small">Data de hoje: <span class="badge" id="hojeLbl"></span></div>
      </div>
      <div style="text-align:right">
        <span class="badge">Meta di√°ria: <span id="metaLbl"></span> L</span>
      </div>
    </div>

    <div class="copoWrap" style="margin-top:12px">
      <div class="copo" aria-label="Copo enchendo">
        <div class="agua" id="agua">
          <div class="wave"></div>
        </div>
      </div>
      <div>
        <div class="pct" id="pct">0%</div>
        <div class="small"><span class="big" id="atualLitros">0.0</span> L de <span class="big" id="metaLitros">4.0</span> L</div>
        <div class="small">Falta: <strong id="faltaLbl">4.0 L</strong></div>
      </div>
    </div>

    <div class="kpis">
      <div class="kpi">
        <strong id="streak">0</strong>
        <span>sequ√™ncia batendo meta</span>
      </div>
      <div class="kpi">
        <strong id="goles">0</strong>
        <span>goles hoje</span>
      </div>
      <div class="kpi">
        <strong id="status">bora hidratar üíß</strong>
        <span>status</span>
      </div>
    </div>

    <hr>

    <div class="grid3">
      <button class="btn primary" onclick="addGole(200)">+200 ml</button>
      <button class="btn primary" onclick="addGole(300)">+300 ml</button>
      <button class="btn primary" onclick="addGole(500)">+500 ml</button>
    </div>

    <label>Adicionar valor personalizado (ml)</label>
    <div class="row">
      <input id="mlCustom" type="number" placeholder="Ex: 250" min="1"/>
      <button class="btn soft" onclick="addCustom()">Adicionar</button>
    </div>

    <hr>

    <h3>Meta e dias (manual)</h3>

    <label>Meta di√°ria (litros)</label>
    <div class="row">
      <input id="metaInput" type="number" step="0.1" min="0.5" placeholder="Ex: 4.0"/>
      <button class="btn ok" onclick="setMeta()">Salvar meta</button>
    </div>
    <div class="small">A meta vale para todos os dias (salva no aparelho).</div>

    <label>Adicionar / editar um dia manualmente</label>
    <div class="row">
      <input id="diaInput" type="date"/>
      <input id="diaMlInput" type="number" placeholder="Total do dia (ml) Ex: 1800" min="0"/>
    </div>
    <div class="grid2" style="margin-top:8px">
      <button class="btn soft" onclick="setDiaManual()">Salvar total do dia</button>
      <button class="btn danger" onclick="apagarDiaManual()">Apagar este dia</button>
    </div>
    <div class="small">Dica: d√° pra adicionar ‚Äúdias zerados‚Äù tamb√©m üòâ</div>

    <hr>

    <details>
      <summary>üì¶ Importar / Exportar (outro aparelho)</summary>

      <div style="margin-top:10px" class="small">
        <strong>Transferir de um aparelho para outro:</strong><br>
        1) No aparelho A: Exportar JSON<br>
        2) Enviar o arquivo (WhatsApp/Email/Drive)<br>
        3) No aparelho B: Importar JSON ‚úÖ
      </div>

      <div class="row" style="margin-top:10px">
        <button class="btn ghost" onclick="exportarJSON()">‚¨áÔ∏è Exportar JSON</button>
        <label class="btn primary" style="text-align:center">
          ‚¨ÜÔ∏è Importar JSON
          <input id="fileImport" type="file" accept="application/json" style="display:none" onchange="importarArquivo(event)"/>
        </label>
      </div>

      <label>Modo de importa√ß√£o</label>
      <select id="importMode">
        <option value="merge">Mesclar (recomendado)</option>
        <option value="replace">Substituir tudo</option>
      </select>
      <div class="small">Mesclar junta os dias. Substituir apaga e troca tudo.</div>

      <label>Ou cole o JSON aqui (se recebeu no WhatsApp)</label>
      <textarea id="jsonText" placeholder="{ ... }"></textarea>
      <div class="grid2">
        <button class="btn soft" onclick="importarTexto()">Importar texto</button>
        <button class="btn danger" onclick="document.getElementById('jsonText').value=''">Limpar</button>
      </div>

    </details>
  </div>

  <!-- DIREITA -->
  <div class="card">
    <div class="row">
      <div>
        <h3>Hoje por horas (acumulado)</h3>
        <div class="small">Cada gole vira um ponto no hor√°rio. Linha tracejada = meta.</div>
      </div>
      <div style="text-align:right">
        <button class="btn ghost" onclick="exportarJSON()">Exportar JSON</button>
      </div>
    </div>
    <canvas id="chartHoras"></canvas>

    <hr>

    <h3>√öltimos 14 dias (total por dia)</h3>
    <div class="small">Consumo di√°rio + linha da meta.</div>
    <canvas id="chartDias" style="margin-top:8px"></canvas>

    <hr>

    <div class="row">
      <div>
        <h3>Hist√≥rico (edit√°vel)</h3>
        <div class="small">Clique no ‚ÄúüëÅÔ∏è‚Äù para ver os goles do dia.</div>
      </div>
      <div style="text-align:right">
        <button class="btn soft" onclick="limparTudo()">Reset (apagar tudo)</button>
      </div>
    </div>

    <div class="list" id="lista"></div>
  </div>

</div>

<div class="toastWrap" id="toastWrap"></div>
<div class="confetti" id="confetti"></div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
/* =========================
   STORAGE MODEL (v2)
   data = {
     userName: string,
     metaMl: number,
     days: {
       "YYYY-MM-DD": { totalMl:number, logs:[{t:"HH:MM", ml:number}] }
     }
   }
========================= */

const LS_KEY = "hidratacao_v2";

function loadData(){
  const raw = localStorage.getItem(LS_KEY);
  if(raw){
    try { return JSON.parse(raw); } catch(e){}
  }
  return { userName:"", metaMl: 4000, days: {} };
}
function saveData(){ localStorage.setItem(LS_KEY, JSON.stringify(DB)); }

let DB = loadData();

const hojeISO = new Date().toISOString().slice(0,10);
ensureDay(hojeISO);

function ensureDay(d){
  if(!DB.days[d]) DB.days[d] = { totalMl: 0, logs: [] };
  if(typeof DB.days[d].totalMl !== "number") DB.days[d].totalMl = 0;
  if(!Array.isArray(DB.days[d].logs)) DB.days[d].logs = [];
}

function nowHHMM(){
  const n = new Date();
  const hh = String(n.getHours()).padStart(2,"0");
  const mm = String(n.getMinutes()).padStart(2,"0");
  return `${hh}:${mm}`;
}

function clamp(n,min,max){ return Math.max(min, Math.min(max,n)); }
function fmtL(ml){ return (ml/1000).toFixed(1); }

function userPrefix(){
  const name = (DB.userName||"").trim();
  return name ? `${name}, ` : "";
}

const frases = {
  elogio: [
    () => `${userPrefix()}voc√™ √© fera! üöÄ`,
    () => `${userPrefix()}a√≠ sim! Hidratando como profissional üòé`,
    () => `${userPrefix()}boa! Seu corpo agradece üíô`,
    () => `${userPrefix()}mandou bem! Consist√™ncia √© tudo üëè`,
    () => `${userPrefix()}top demais! Voc√™ t√° no controle üî•`
  ],
  incentivo: [
    () => `${userPrefix()}bora dar mais um gole? üíß`,
    () => `${userPrefix()}√°gua = energia + foco ‚ö°`,
    () => `${userPrefix()}hidrata√ß√£o ajuda o intestino a funcionar melhor üòâ`,
    () => `${userPrefix()}a pele, o treino e o c√©rebro agradecem üß†`,
    () => `${userPrefix()}pequenos goles ao longo do dia funcionam melhor üòÑ`
  ],
  curiosidade: [
    () => "Dica: beber aos poucos costuma ser melhor do que ‚Äòvirar‚Äô muita √°gua de uma vez.",
    () => "Dica: √°gua antes do caf√© pode reduzir desconforto g√°strico ‚òïüíß",
    () => "Dica: colocou um alarme de 2 em 2 horas? vira h√°bito rapidinho ‚è∞",
    () => "Dica: depois do treino, um gole grande ajuda a recuperar.",
    () => "Dica: se a urina est√° muito escura, geralmente √© sinal de pouca √°gua."
  ],
  meta: [
    () => `${userPrefix()}META BATIDA! Voc√™ √© fera! üèÜüíß`,
    () => `${userPrefix()}chegou na meta! Orgulho do seu eu de amanh√£ üòÑ`,
    () => `${userPrefix()}meta completada! Agora √© s√≥ manter o ritmo üíô`,
    () => `${userPrefix()}voc√™ venceu o dia: hidratado e consciente üî•`,
  ]
};

function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]() }

function toast(title, text){
  const wrap = document.getElementById("toastWrap");
  const div = document.createElement("div");
  div.className = "toast";
  div.innerHTML = `
    <div>
      <div class="tTitle">${title}</div>
      <div class="tText">${text}</div>
    </div>
    <button class="x" aria-label="Fechar">OK</button>
  `;
  wrap.appendChild(div);
  div.querySelector(".x").onclick = () => div.remove();
  setTimeout(()=>{ if(div.isConnected) div.remove(); }, 5200);
}

function confetti(){
  const c = document.getElementById("confetti");
  c.innerHTML = "";
  for(let i=0;i<45;i++){
    const p = document.createElement("i");
    const left = Math.random()*100;
    const delay = Math.random()*0.25;
    const dur = 1.2 + Math.random()*0.9;
    const w = 6 + Math.random()*10;
    const h = 10 + Math.random()*16;
    const hue = 190 + Math.random()*40;
    p.style.left = left+"vw";
    p.style.animationDelay = delay+"s";
    p.style.animationDuration = dur+"s";
    p.style.width = w+"px";
    p.style.height = h+"px";
    p.style.background = `hsl(${hue} 80% 52%)`;
    c.appendChild(p);
  }
  setTimeout(()=> c.innerHTML="", 2000);
}

/* =========================
   PROFILE (NAME)
========================= */
function setNome(){
  const v = (document.getElementById("nomeInput").value || "").trim();
  DB.userName = v;
  saveData();
  updateTitle();
  toast("Salvo ‚úÖ", v ? `Fechou, ${v}! Agora ficou bonit√£o üòÑ` : "Nome removido. (Voc√™ pode colocar de novo quando quiser.)");
}

function updateTitle(){
  const name = (DB.userName||"").trim();
  document.getElementById("titleTop").textContent = name ? `üíß Controle de Hidrata√ß√£o ‚Äî ${name}` : "üíß Controle de Hidrata√ß√£o";
}

/* =========================
   ACTIONS
========================= */
let metaBateuHoje = false;

function addGole(ml){
  ensureDay(hojeISO);
  const before = DB.days[hojeISO].totalMl;

  DB.days[hojeISO].totalMl += ml;
  DB.days[hojeISO].logs.push({ t: nowHHMM(), ml });

  saveData();
  render();

  toast("Registrado üíß", `${ml} ml √†s ${DB.days[hojeISO].logs.at(-1).t}. ${pick(frases.incentivo)}`);

  const after = DB.days[hojeISO].totalMl;
  if(!metaBateuHoje && before < DB.metaMl && after >= DB.metaMl){
    metaBateuHoje = true;
    toast("üèÜ Meta batida!", pick(frases.meta));
    confetti();
  }else if(after < DB.metaMl){
    if(Math.random() < 0.30) toast("Boa!", pick(frases.elogio));
  }
}

function addCustom(){
  const v = Number(document.getElementById("mlCustom").value || 0);
  if(v <= 0) return toast("Ops", "Coloca um valor em ml maior que zero üôÇ");
  document.getElementById("mlCustom").value = "";
  addGole(v);
}

function setMeta(){
  const v = Number(document.getElementById("metaInput").value || 0);
  if(v < 0.5) return toast("Meta inv√°lida", "Coloca pelo menos 0.5 L (ex: 4.0).");
  DB.metaMl = Math.round(v * 1000);
  saveData();
  toast("Meta salva ‚úÖ", `Meta di√°ria definida para ${v.toFixed(1)} L. ${pick(frases.curiosidade)}`);
  render();
}

function setDiaManual(){
  const d = document.getElementById("diaInput").value;
  const ml = Number(document.getElementById("diaMlInput").value ?? NaN);
  if(!d) return toast("Escolha uma data", "Selecione o dia que voc√™ quer adicionar/editar.");
  if(Number.isNaN(ml) || ml < 0) return toast("Valor inv√°lido", "Digite o total do dia em ml (ex: 1800).");

  ensureDay(d);
  DB.days[d].totalMl = ml;
  saveData();
  toast("Dia atualizado üóìÔ∏è", `${d} agora est√° com ${fmtL(ml)} L.`);
  render();
}

function apagarDiaManual(){
  const d = document.getElementById("diaInput").value;
  if(!d) return toast("Escolha uma data", "Selecione um dia para apagar.");
  if(!DB.days[d]) return toast("Nada pra apagar", "Esse dia n√£o existe no hist√≥rico.");
  delete DB.days[d];
  saveData();
  toast("Apagado üóëÔ∏è", `Removi o dia ${d} do hist√≥rico.`);
  render();
}

function apagarDia(d){
  if(!confirm(`Apagar o dia ${d}?`)) return;
  delete DB.days[d];
  saveData();
  render();
  toast("Ok", `Dia ${d} removido.`);
}

function editarTotalDia(d){
  const cur = DB.days[d]?.totalMl ?? 0;
  const input = prompt(`Editar total do dia ${d} (ml)`, String(cur));
  if(input === null) return;
  const v = Number(input);
  if(Number.isNaN(v) || v < 0) return toast("Valor inv√°lido", "Use um n√∫mero em ml (ex: 1500).");
  ensureDay(d);
  DB.days[d].totalMl = v;
  saveData();
  render();
  toast("Atualizado ‚úÖ", `${d}: ${fmtL(v)} L.`);
}

function verLogsDia(d){
  ensureDay(d);
  const logs = DB.days[d].logs || [];
  if(!logs.length){
    return toast("Sem goles", `N√£o h√° registros por hor√°rio em ${d}. (Voc√™ pode registrar no dia com os bot√µes.)`);
  }
  const linhas = logs.slice(-40).map(x=>`‚Ä¢ ${x.t} ‚Äî ${x.ml} ml`).join("\n");
  alert(`Goles de ${d} (√∫ltimos ${Math.min(40, logs.length)}):\n\n${linhas}`);
}

function limparTudo(){
  if(!confirm("Apagar tudo mesmo? (hist√≥rico inteiro)")) return;
  const keepName = DB.userName || "";
  DB = { userName: keepName, metaMl: 4000, days: {} };
  ensureDay(hojeISO);
  saveData();
  toast("Reset feito", "Come√ßou do zero. Bora hidratar! üíß");
  render();
}

function exportarJSON(){
  const blob = new Blob([JSON.stringify(DB, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "hidratacao.json";
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
  toast("Exportado ‚úÖ", "Baixei seu JSON. Use Importar no outro aparelho.");
}

/* =========================
   IMPORT (FILE / TEXT)
========================= */
function normalizeImported(obj){
  // Aceita v2; tenta adaptar v1 simples (se o usu√°rio colar coisas antigas)
  if(!obj || typeof obj !== "object") return null;

  // J√° √© v2?
  if(obj.days && typeof obj.metaMl === "number"){
    if(typeof obj.userName !== "string") obj.userName = "";
    // normaliza days
    for(const d of Object.keys(obj.days)){
      const day = obj.days[d];
      if(!day || typeof day !== "object") obj.days[d] = { totalMl: 0, logs: [] };
      if(typeof obj.days[d].totalMl !== "number") obj.days[d].totalMl = 0;
      if(!Array.isArray(obj.days[d].logs)) obj.days[d].logs = [];
    }
    return obj;
  }

  // Formato antigo poss√≠vel: { metaMl, days: { date: number } } ou { date: number }
  // Se vier como dicion√°rio de datas->ml
  const isFlatDates = Object.keys(obj).some(k => /^\d{4}-\d{2}-\d{2}$/.test(k));
  if(isFlatDates){
    const out = { userName:"", metaMl: 4000, days:{} };
    for(const k of Object.keys(obj)){
      if(/^\d{4}-\d{2}-\d{2}$/.test(k)){
        out.days[k] = { totalMl: Number(obj[k]||0), logs: [] };
      }
    }
    return out;
  }

  return null;
}

function mergeData(current, incoming){
  const out = structuredClone(current);

  // meta: mant√©m a maior (mais seguro) ‚Äî voc√™ pode mudar depois
  if(typeof incoming.metaMl === "number"){
    out.metaMl = Math.max(out.metaMl || 0, incoming.metaMl);
  }

  // nome: se o atual est√° vazio e o importado tem, pega
  if(!(out.userName||"").trim() && (incoming.userName||"").trim()){
    out.userName = incoming.userName;
  }

  // dias: soma/mescla
  for(const d of Object.keys(incoming.days || {})){
    ensureDay(d); // garante no DB atual
    if(!out.days[d]) out.days[d] = { totalMl: 0, logs: [] };

    const incDay = incoming.days[d];
    const curDay = out.days[d];

    // totalMl: pega o maior (evita duplicar se voc√™ importou duas vezes)
    curDay.totalMl = Math.max(curDay.totalMl || 0, incDay.totalMl || 0);

    // logs: mescla por "t|ml" (evita duplicar)
    const seen = new Set((curDay.logs||[]).map(x => `${x.t}|${x.ml}`));
    for(const g of (incDay.logs||[])){
      const key = `${g.t}|${g.ml}`;
      if(!seen.has(key)){
        curDay.logs.push({t:String(g.t||"00:00"), ml:Number(g.ml||0)});
        seen.add(key);
      }
    }
  }

  return out;
}

function importarObjeto(obj){
  const inc = normalizeImported(obj);
  if(!inc) return toast("Import falhou", "JSON inv√°lido ou formato desconhecido.");

  const mode = document.getElementById("importMode").value;

  if(mode === "replace"){
    DB = inc;
    // garante hoje existe
    ensureDay(hojeISO);
    saveData();
    updateTitle();
    render();
    toast("Importado ‚úÖ", "Dados substitu√≠dos com sucesso.");
    return;
  }

  // merge
  DB = mergeData(DB, inc);
  ensureDay(hojeISO);
  saveData();
  updateTitle();
  render();
  toast("Importado ‚úÖ", "Dados mesclados com sucesso.");
}

function importarArquivo(ev){
  const file = ev.target.files?.[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    try{
      const obj = JSON.parse(reader.result);
      importarObjeto(obj);
    }catch(e){
      toast("Erro", "N√£o consegui ler esse JSON. Tenta exportar novamente do outro aparelho.");
    }
    ev.target.value = "";
  };
  reader.readAsText(file);
}

function importarTexto(){
  const txt = (document.getElementById("jsonText").value || "").trim();
  if(!txt) return toast("Nada pra importar", "Cole o JSON primeiro.");
  try{
    const obj = JSON.parse(txt);
    importarObjeto(obj);
    document.getElementById("jsonText").value = "";
  }catch(e){
    toast("Erro", "O texto n√£o parece ser um JSON v√°lido.");
  }
}

/* =========================
   CHARTS
========================= */
let chartHoras = null;
let chartDias = null;

function buildSeriesHoras(dayISO){
  ensureDay(dayISO);
  const logs = DB.days[dayISO].logs.slice().sort((a,b)=> String(a.t).localeCompare(String(b.t)));
  const labels = [];
  const data = [];
  let acc = 0;

  if(!logs.length){
    labels.push("00:00");
    data.push(0);
    return {labels, data};
  }

  labels.push(logs[0].t);
  data.push(0);

  for(const g of logs){
    acc += Number(g.ml||0);
    labels.push(g.t);
    data.push(acc/1000);
  }
  return {labels, data};
}

function buildSeriesDiasLast14(){
  const keys = Object.keys(DB.days).sort();
  const last = keys.slice(-14);
  const labels = last;
  const data = last.map(d => (DB.days[d]?.totalMl ?? 0)/1000);
  const metaLine = last.map(()=> DB.metaMl/1000);
  return {labels, data, metaLine};
}

function renderCharts(){
  const horas = buildSeriesHoras(hojeISO);
  const ctxH = document.getElementById("chartHoras").getContext("2d");

  if(chartHoras) chartHoras.destroy();
  chartHoras = new Chart(ctxH, {
    type:"line",
    data:{
      labels: horas.labels,
      datasets:[
        {
          label:"Acumulado (L)",
          data: horas.data,
          borderColor:"#0b3c5d",
          backgroundColor:"rgba(31,111,163,.18)",
          fill:true,
          tension:.35,
          pointRadius:3,
          pointHoverRadius:5
        },
        {
          label:"Meta",
          data: horas.labels.map(()=> DB.metaMl/1000),
          borderColor:"#1f6fa3",
          borderDash:[6,6],
          pointRadius:0,
          tension:0
        }
      ]
    },
    options:{
      plugins:{legend:{labels:{font:{size:14}, color:"#0e2233"}}},
      scales:{
        y:{beginAtZero:true, ticks:{font:{size:13}, color:"#0e2233"}},
        x:{ticks:{font:{size:12}, color:"#0e2233", maxRotation:0, autoSkip:true}}
      }
    }
  });

  const days = buildSeriesDiasLast14();
  const ctxD = document.getElementById("chartDias").getContext("2d");

  if(chartDias) chartDias.destroy();
  chartDias = new Chart(ctxD,{
    type:"line",
    data:{
      labels: days.labels,
      datasets:[
        {
          label:"Consumo (L)",
          data: days.data,
          borderColor:"#0b3c5d",
          backgroundColor:"rgba(31,111,163,.14)",
          fill:true,
          tension:.35,
          pointRadius:3,
          pointHoverRadius:5
        },
        {
          label:"Meta",
          data: days.metaLine,
          borderColor:"#1f6fa3",
          borderDash:[6,6],
          pointRadius:0,
          tension:0
        }
      ]
    },
    options:{
      plugins:{legend:{labels:{font:{size:14}, color:"#0e2233"}}},
      scales:{
        y:{beginAtZero:true, ticks:{font:{size:13}, color:"#0e2233"}},
        x:{ticks:{font:{size:12}, color:"#0e2233", maxRotation:0, autoSkip:true}}
      }
    }
  });
}

/* =========================
   STREAK + STATUS
========================= */
function calcStreak(){
  const keys = Object.keys(DB.days).sort();
  let streak = 0;
  for(let i=keys.length-1;i>=0;i--){
    const d = keys[i];
    const total = DB.days[d]?.totalMl ?? 0;
    if(total >= DB.metaMl) streak++;
    else break;
  }
  return streak;
}
function statusText(pct){
  if(pct >= 100) return "meta batida üèÜ";
  if(pct >= 75) return "t√° voando üî•";
  if(pct >= 50) return "no caminho üòé";
  if(pct >= 25) return "bom come√ßo üëè";
  return "bora hidratar üíß";
}

/* =========================
   LIST
========================= */
function renderList(){
  const list = document.getElementById("lista");
  list.innerHTML = "";
  const keys = Object.keys(DB.days).sort().reverse();

  if(!keys.length){
    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `<div class="left"><strong>Sem hist√≥rico</strong><span class="small">Comece registrando alguns goles üòÑ</span></div>`;
    list.appendChild(div);
    return;
  }

  for(const d of keys){
    const total = DB.days[d]?.totalMl ?? 0;
    const pct = clamp(Math.round((total/DB.metaMl)*100), 0, 999);
    const logsCount = (DB.days[d]?.logs?.length ?? 0);

    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `
      <div class="left">
        <strong>${d}</strong>
        <span class="small">${fmtL(total)} L ‚Ä¢ ${pct}% da meta ‚Ä¢ ${logsCount} goles</span>
      </div>
      <div class="right">
        <button class="iconBtn" title="Ver goles" onclick="verLogsDia('${d}')">üëÅÔ∏è</button>
        <button class="iconBtn" title="Editar total" onclick="editarTotalDia('${d}')">‚úèÔ∏è</button>
        <button class="iconBtn" title="Apagar dia" onclick="apagarDia('${d}')">üóëÔ∏è</button>
      </div>
    `;
    list.appendChild(div);
  }
}

/* =========================
   RENDER
========================= */
function render(){
  updateTitle();

  document.getElementById("hojeLbl").textContent = hojeISO;
  document.getElementById("metaLbl").textContent = (DB.metaMl/1000).toFixed(1);
  document.getElementById("metaLitros").textContent = (DB.metaMl/1000).toFixed(1);
  document.getElementById("metaInput").value = (DB.metaMl/1000).toFixed(1);

  document.getElementById("nomeInput").value = DB.userName || "";

  ensureDay(hojeISO);
  const t = DB.days[hojeISO].totalMl;
  const pct = clamp(Math.round((t/DB.metaMl)*100), 0, 100);
  const falta = Math.max(0, DB.metaMl - t);

  document.getElementById("atualLitros").textContent = fmtL(t);
  document.getElementById("pct").textContent = pct + "%";
  document.getElementById("faltaLbl").textContent = fmtL(falta) + " L";
  document.getElementById("agua").style.height = pct + "%";

  document.getElementById("streak").textContent = calcStreak();
  document.getElementById("goles").textContent = DB.days[hojeISO].logs.length;
  document.getElementById("status").textContent = statusText(pct);

  metaBateuHoje = (t >= DB.metaMl);

  if(!document.getElementById("diaInput").value){
    document.getElementById("diaInput").value = hojeISO;
  }

  renderCharts();
  renderList();
}

/* =========================
   BOOT
========================= */
toast("Bem-vindo üëã", "Agora voc√™ pode IMPORTAR do outro aparelho e colocar seu nome no topo. " + pick(frases.curiosidade));
render();
</script>
</body>
</html>
